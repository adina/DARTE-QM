---
title: "Mock-Communit Analysis"
author: <a href="https://schuyler-smith.github.io/" target="_blank" >Schuyler D. Smith</a>
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---
<br>
<br>


```{r setup, message=FALSE, warning=FALSE, echo=FALSE}
library(data.table)
library(ggplot2)
library(data.table)
```

```{r create_mock_counts, message=FALSE, warning=FALSE, echo=FALSE}
rrna <- c('HM798937.1.1383','LC124582.1.1424','GQ927630.1.918','FJ680748.1.1374',
          'FJ455902.1.1529','KY355700.1.900','KP308750.18552.19877','MH337785.1',
          'AY779826.1.900','FR685529.1.1448','FJ365469.1.1342','JQ278775.1.1454',
          'MH938429.1','FJ363919.1.1352','FJ516926.1.1472','JN521105.1.1285',
          'KP090991.1.1467','FJ716960.1.1550','MH938447.1','KT381382.1.900',
          'KY898052.1','KY898059.1','FPLP01012084.16.1433','FJ478940.1.1496',
          'b0463','SL1344_RS02425')

mock_blast <- data.table::fread('../../data/mock/mock_targets.blast')

mock_blast <- mock_blast[!(V1 %in% rrna)]

mock_blast <- mock_blast[V4 > 200]
mock_blast <- mock_blast[V3 > 93]
setorder(mock_blast, 'V2', 'V9')

strains[, Abundance := Genome_copies_per_microgram * micrograms]

mock_genome <- vector()
for(genome in mock_blast$V2){
	genome <- mock_genome_names[sapply(strsplit(mock_genome_names, ' '), FUN=function(x){any(x %in% genome)})]
	genome <- strains[apply(strains,1,FUN=function(x){any(x %in% unlist(strsplit(genome, " ")))})]$Strain
	mock_genome <- c(mock_genome, genome)
} 

mock_genomes[, ARG := classifications[[2]][match(mock_genomes[['V1']], classifications[[3]])]]
mock_genomes[, ARG_Family := classifications[[1]][match(mock_genomes[['V1']], classifications[[3]])]]
mock_genomes$V4[-c(1,2,39,41,42,44,45,57,82,83)]
a <- mock_genomes[,c('V2', 'V1', 'V9', 'ARG', 'ARG_Family')]

setnames(a, c('V2','V1'), c('Microbe', 'Primer'))

a[, abundance := mock_info[unlist(sapply(a[[1]], grep, mock_info$Strain))]$Abundance]
a$abundance[1:3] <- a$abundance[1:3]/3
a$abundance[39:40] <- a$abundance[39:40]/2
a$abundance[41:43] <- a$abundance[41:43]/2
a$abundance[44:46] <- a$abundance[44:46]/3
a$abundance[57:58] <- a$abundance[57:58]/2
a$abundance[82:84] <- a$abundance[82:84]/3

a <- a[, .(count = sum(abundance)), by = c( 'ARG_Family', "ARG", 'Primer', "Microbe")]
a[, count := (count/sum(count))]
# a
a[,Sample := 'Theoretical']
setcolorder(a, c("Sample", "Microbe", "ARG", "ARG_Family", 'Primer', "count"))
saveRDS(a, '../data/mock_ARG_counts.rds')
mock_ARGs <- readRDS('../data/mock_ARG_counts.rds')
set(mock_ARGs, j = "Primer", value = gsub('\\:', '_', mock_ARGs$Primer))
expected_mock <- mock_ARGs$Primer
mock_samples <- metadata[grep('Mock', metadata$`Sample Name`),][Analyzed == TRUE]$`Sample Name`


```